<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracking - AI Study Planner</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .nav-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary);
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .progress-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .section-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .section-title {
            color: var(--dark);
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subject-progress-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .subject-name {
            font-weight: 600;
            color: #333;
        }
        .progress-percent {
            font-weight: bold;
            color: var(--primary);
        }
        .progress-container {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        .time-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        .time-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: 600;
        }
        .time-0 { background: #ebedf0; }
        .time-1 { background: #9be9a8; }
        .time-2 { background: #40c463; }
        .time-3 { background: #30a14e; }
        .time-4 { background: #216e39; }
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .insight-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-content {
            color: #666;
            line-height: 1.5;
        }
        .download-btn {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .download-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        .export-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        @media (max-width: 768px) {
            .progress-section {
                grid-template-columns: 1fr;
            }
            .time-grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 style="margin: 0; color: var(--primary);">üìä Progress Tracking</h1>
                <p style="margin: 5px 0 0 0; color: #666;">Monitor your learning journey with detailed analytics</p>
            </div>
            <div>
                <a href="/dashboard" class="nav-btn">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-menu">
            <a href="/dashboard" class="nav-btn">üè† Dashboard</a>
            <a href="/subject_management" class="nav-btn">üìñ Subjects</a>
            <a href="/ai_schedule_generator" class="nav-btn">ü§ñ AI Schedule</a>
            <a href="/progress_tracking" class="nav-btn" style="background: var(--secondary);">üìä Progress</a>
            <a href="/ai_tutoring" class="nav-btn">üéì AI Tutor</a>
            <a href="/mood_tracker" class="nav-btn">üòä Mood Tracker</a>
            <a href="/goals" class="nav-btn">üéØ Goals</a>
            <a href="/settings" class="nav-btn">‚öôÔ∏è Settings</a>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value">{{ streak }} days</div>
                <div class="stat-label">Current Study Streak</div>
                {% if streak >= 7 %}
                    <span class="badge badge-success">Consistent!</span>
                {% elif streak >= 3 %}
                    <span class="badge badge-warning">Good progress</span>
                {% else %}
                    <span class="badge badge-info">Keep going!</span>
                {% endif %}
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value">
                    {{ (total_minutes // 60) }}h {{ total_minutes % 60 }}m
                </div>
                <div class="stat-label">Total Study Time (30 days)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value">{{ subject_progress|length }}</div>
                <div class="stat-label">Active Subjects</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-value">
                    {{ avg_daily|round|int }} min/day
                </div>
                <div class="stat-label">Daily Average</div>
            </div>
        </div>

        <!-- Main Progress Section -->
        <div class="progress-section">
            <!-- Subject Progress -->
            <div class="section-card">
                <h2 class="section-title">üìñ Subject-wise Progress</h2>
                {% if subject_progress %}
                    {% for subject in subject_progress %}
                    <div class="subject-progress-item">
                        <div class="subject-header">
                            <span class="subject-name">{{ subject.subject_name }}</span>
                            <span class="progress-percent">{{ subject.completion_rate|round(1) }}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ subject.completion_rate }}%"></div>
                        </div>
                        <div class="progress-details">
                            <span>{{ subject.completed_topics }} of {{ subject.total_topics }} topics</span>
                            <span>
                                {% if subject.completion_rate >= 80 %}
                                    üéâ Excellent!
                                {% elif subject.completion_rate >= 60 %}
                                    üëç Good progress
                                {% elif subject.completion_rate >= 40 %}
                                    üìà Keep going
                                {% else %}
                                    üöÄ Start strong
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="text-align: center; color: #666; padding: 20px;">
                        No progress data yet. Start studying to track your progress!
                    </p>
                {% endif %}
            </div>

            <!-- Study Time Chart -->
            <div class="section-card">
                <h2 class="section-title">‚è∞ Study Activity</h2>
                <div class="chart-container">
                    <canvas id="studyTimeChart"></canvas>
                </div>
                
                <!-- Heatmap -->
                <h3 style="margin-top: 30px;">üî• Study Heatmap (Last 30 days)</h3>
                <div class="time-grid" id="heatmap">
                    <!-- Heatmap cells will be generated by JavaScript -->
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ebedf0;"></div>
                        <span>0 min</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9be9a8;"></div>
                        <span>1-60 min</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #40c463;"></div>
                        <span>1-2 hrs</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #30a14e;"></div>
                        <span>2-3 hrs</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #216e39;"></div>
                        <span>3+ hrs</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="section-card">
            <h2 class="section-title">ü§ñ AI Insights & Recommendations</h2>
            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-title">üìà Performance Analysis</div>
                    <div class="insight-content">
                        {% set avg_completion = subject_progress|sum(attribute='completion_rate') / subject_progress|length if subject_progress|length > 0 else 0 %}
                        {% if avg_completion >= 70 %}
                            You're making excellent progress! Your completion rate of {{ avg_completion|round(1) }}% is above average.
                        {% elif avg_completion >= 40 %}
                            Good steady progress. Focus on completing more topics to reach your goals faster.
                        {% else %}
                            Time to ramp up! Try to study at least 2 hours daily to catch up.
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">üéØ Focus Areas</div>
                    <div class="insight-content">
                        {% set weakest_subject = subject_progress|sort(attribute='completion_rate')|first if subject_progress %}
                        {% if weakest_subject and weakest_subject.completion_rate < 50 %}
                            Focus more on <strong>{{ weakest_subject.subject_name }}</strong> ({{ weakest_subject.completion_rate|round(1) }}% complete).
                        {% else %}
                            All subjects are progressing well. Keep up the balanced approach!
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">‚è±Ô∏è Time Management</div>
                    <div class="insight-content">
                        {% if avg_daily < 120 %}
                            You're studying {{ avg_daily|round|int }} minutes daily. Try to reach 2 hours for better results.
                        {% elif avg_daily < 180 %}
                            Good study duration! {{ (avg_daily/60)|round(1) }} hours daily is effective.
                        {% else %}
                            Excellent study time! You're putting in {{ (avg_daily/60)|round(1) }} hours daily.
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">üìÖ Consistency</div>
                    <div class="insight-content">
                        {% if streak >= 7 %}
                            Amazing! You've studied for {{ streak }} consecutive days. Keep this momentum!
                        {% elif streak >= 3 %}
                            Good consistency! A {{ streak }}-day streak shows commitment.
                        {% else %}
                            Build your study habit. Try to study every day to establish a routine.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="section-card">
            <h2 class="section-title">üì§ Export Progress Report</h2>
            <p style="color: #666; margin-bottom: 20px;">Download your progress report for offline viewing or sharing</p>
            
            <div class="export-options">
                <button class="download-btn" onclick="exportPDF()">
                    üìÑ Export as PDF
                </button>
                
                <button class="download-btn" onclick="exportCSV()">
                    üìä Export as CSV
                </button>
                
                <button class="download-btn" onclick="shareProgress()">
                    üîó Share Progress
                </button>
                
                <a href="/export_progress_report" class="download-btn">
                    üìã Export Full Report
                </a>
            </div>
        </div>
    </div>

    <script>
        // Initialize Study Time Chart
        const ctx = document.getElementById('studyTimeChart').getContext('2d');
        
        // Prepare data for last 7 days
        const progressData = {{ progress_data|tojson|safe }};
        
        // Convert dates to JavaScript format and get last 7 days
        const last7Days = [];
        const studyTimes = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const dateDisplay = `${date.getDate()}/${date.getMonth() + 1}`;
            
            // Find data for this date
            const dataForDate = progressData.find(d => d.date === dateStr);
            const minutes = dataForDate ? dataForDate.total_minutes : 0;
            
            last7Days.push(dateDisplay);
            studyTimes.push(minutes / 60);
        }
        
        const studyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Study Time (hours)',
                    data: studyTimes,
                    backgroundColor: 'rgba(67, 97, 238, 0.7)',
                    borderColor: 'rgba(67, 97, 238, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Hours'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Study time: ${context.raw.toFixed(1)} hours`;
                            }
                        }
                    }
                }
            }
        });
        
        // Generate heatmap
        function generateHeatmap() {
            const heatmapContainer = document.getElementById('heatmap');
            heatmapContainer.innerHTML = '';
            
            // Create 30 days of cells
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Find data for this date
                const dataForDate = progressData.find(d => d.date === dateStr);
                const minutes = dataForDate ? dataForDate.total_minutes : 0;
                
                // Calculate intensity (0-4)
                let intensity;
                if (minutes === 0) intensity = 0;
                else if (minutes <= 60) intensity = 1;
                else if (minutes <= 120) intensity = 2;
                else if (minutes <= 180) intensity = 3;
                else intensity = 4;
                
                const cell = document.createElement('div');
                cell.className = `time-cell time-${intensity}`;
                cell.title = `${dateStr}: ${minutes} min`;
                cell.textContent = minutes > 0 ? minutes : '';
                
                heatmapContainer.appendChild(cell);
            }
        }
        
        // Call heatmap generation
        generateHeatmap();
        
        // Export functions
        function exportPDF() {
            alert('PDF export feature will be implemented soon!\nYour progress report will be generated as PDF.');
        }
        
        function exportCSV() {
            // Create CSV content
            let csvContent = "Date,Study Time (minutes),Sessions\n";
            
            // Add progress data
            progressData.forEach(data => {
                csvContent += `"${data.date}",${data.total_minutes},${data.sessions}\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study_progress.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('CSV file downloaded successfully!');
        }
        
        function shareProgress() {
            const streak = {{ streak }};
            const totalSubjects = {{ subject_progress|length }};
            const totalHours = {{ (total_minutes // 60) }};
            const totalMinutes = {{ total_minutes % 60 }};
            
            const shareText = `üìö My Study Progress from AI Study Planner:\n\nüî• ${streak}-day streak\nüìñ ${totalSubjects} subjects\n‚è±Ô∏è ${totalHours}h ${totalMinutes}m studied\n\nTrack your progress at: ${window.location.origin}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Study Progress',
                    text: shareText,
                    url: window.location.href
                }).then(() => {
                    console.log('Share successful');
                }).catch(error => {
                    console.log('Error sharing:', error);
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Progress copied to clipboard! Share it anywhere.');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard. Please copy manually.');
            });
        }
        
        // Load analytics data
        function loadAnalytics() {
            fetch('/get_progress_analytics')
                .then(response => response.json())
                .then(data => {
                    console.log('Analytics data:', data);
                    // You can use this data to create more detailed charts
                })
                .catch(error => console.error('Error loading analytics:', error));
        }
        
        // Auto-refresh every 5 minutes
        setTimeout(() => location.reload(), 300000);
        
        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
</body>
</html>